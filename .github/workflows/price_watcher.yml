name: Weekly Price Watcher (Flipp Smart Match)
on:
  schedule:
    - cron: '0 0 * * 0' # Sunday at Midnight
  workflow_dispatch:

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests supabase

      - name: Run Smart Scraper
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python - <<EOF
          import os
          import requests
          from supabase import create_client

          supabase = create_client(os.getenv("SUPABASE_URL"), os.getenv("SUPABASE_KEY"))
          
          # 1. Fetch items to watch
          items = supabase.table("prices").select("*").eq("is_watched", True).execute().data
          postal_code = "T6X1V3"

          print(f"Starting Smart Match for {len(items)} items in {postal_code}...")

          for item in items:
              try:
                  item_name = item.get('item_name', '')
                  brand = (item.get('brand') or '').lower()
                  target_store = item['store_name'].lower() 
                  
                  # Search broadly by Item Name only
                  print(f"\nüîç SEARCHING FLIPP FOR: '{item_name}'")

                  flipp_url = f"https://backflipp.wishabi.com/flipp/items/search?q={item_name}&postal_code={postal_code}"
                  headers = {"User-Agent": "Mozilla/5.0"}
                  
                  response = requests.get(flipp_url, headers=headers).json()
                  flipp_results = response.get('items', [])

                  new_price = None
                  match_found = None

                  for res in flipp_results:
                      merchant = res.get('merchant_name', '').lower()
                      title = res.get('name', '').lower()
                      
                      # LOGIC 1: Must match the store (e.g. Walmart)
                      if target_store in merchant:
                          # LOGIC 2: If we have a brand, it must be in the title
                          # If we don't have a brand, any match in the store works
                          if brand and brand not in title:
                              continue
                          
                          # LOGIC 3: Robust Price Extraction
                          # We check 'current_price' first, then 'price' (where Blueberries likely was)
                          raw_price = res.get('current_price') or res.get('price')
                          
                          if raw_price:
                              new_price = float(raw_price)
                              match_found = res.get('name')
                              break 

                  if new_price:
                      # 3. Update Supabase
                      supabase.table("prices").update({
                          "price": new_price,
                          "last_automated_update": "now()"
                      }).eq("id", item['id']).execute()
                      print(f"   ‚úÖ MATCH: {match_found} at {target_store} -> ${new_price}")
                  else:
                      print(f"   ‚ùå Could not find a price for '{item_name}' (Brand: {brand}) at {target_store}")

              except Exception as e:
                  print(f"   ‚ö†Ô∏è Error: {str(e)}")
          EOF
