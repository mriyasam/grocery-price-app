name: Weekly Price Watcher (Google Shopping)
on:
  schedule:
    - cron: '0 0 * * 0' # Every Sunday
  workflow_dispatch:

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Tools
        run: pip install requests supabase

      - name: Run Scraper
        env:
          SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python - <<EOF
          import os
          import requests
          from supabase import create_client

          supabase = create_client(os.getenv("SUPABASE_URL"), os.getenv("SUPABASE_KEY"))
          
          # Fetch only watched items
          items = supabase.table("prices").select("*").eq("is_watched", True).execute().data
          print(f"Checking {len(items)} watched items via Google Shopping...")

          for item in items:
              try:
                  # SEARCH QUERY: "Brand + Item Name + Walmart Canada"
                  # This is the most reliable way to find the price Google has indexed.
                  query = f"{item.get('brand', '')} {item['item_name']} Walmart Canada".strip()
                  print(f"\nüîç SEARCHING: '{query}'")

                  params = {
                      "engine": "google_shopping",
                      "q": query,
                      "google_domain": "google.ca",
                      "location": "Edmonton, Alberta, Canada",
                      "api_key": os.getenv("SERPAPI_KEY")
                  }
                  
                  response = requests.get("https://serpapi.com/search", params=params).json()
                  
                  # Look through shopping results for Walmart
                  shopping_results = response.get('shopping_results', [])
                  new_price = None

                  for res in shopping_results:
                      source = res.get('source', '').lower()
                      # We want to make sure the price is coming from Walmart
                      if 'walmart' in source:
                          new_price = res.get('price')
                          print(f"   ‚úÖ Found on Google: {res.get('title')} at {source} -> {new_price}")
                          break

                  if new_price:
                      # Clean price string (e.g. "$12.97" -> 12.97)
                      final_price = float(str(new_price).replace('$', '').replace(',', '').strip())
                      
                      supabase.table("prices").update({
                          "price": final_price,
                          "last_automated_update": "now()"
                      }).eq("id", item['id']).execute()
                      print(f"‚úÖ DATABASE UPDATED: ${final_price}")
                  else:
                      print(f"‚ùå NOT FOUND: Google Shopping did not show a Walmart price for this item.")

              except Exception as e:
                  print(f"‚ö†Ô∏è ERROR: {str(e)}")
          EOF
