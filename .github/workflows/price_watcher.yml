name: Weekly Price Watcher (Flipp Smart Match)
on:
  schedule:
    - cron: '0 0 * * 0' # Sunday at Midnight
  workflow_dispatch:

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests supabase

      - name: Run Smart Scraper
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python - <<EOF
          import os
          import requests
          import re
          from supabase import create_client

          supabase = create_client(os.getenv("SUPABASE_URL"), os.getenv("SUPABASE_KEY"))
          
          # 1. Fetch watched items
          items = supabase.table("prices").select("*").eq("is_watched", True).execute().data
          postal_code = "T6X1V3"

          print(f"Starting Robust Scraper for {len(items)} items...")

          def clean_price(val):
              if not val: return None
              # Extract numbers and decimals only (e.g. "$3.97" -> 3.97)
              match = re.search(r"(\d+\.\d{2})", str(val))
              return float(match.group(1)) if match else None

          for item in items:
              try:
                  # Safely handle potential NULL values from Database
                  name_raw = item.get('item_name') or ""
                  brand_raw = item.get('brand') or ""
                  store_raw = item.get('store_name') or ""
                  
                  target_store = store_raw.lower()
                  brand = brand_raw.lower()

                  print(f"\nüîç SEARCHING FLIPP: '{name_raw}'")

                  flipp_url = f"https://backflipp.wishabi.com/flipp/items/search?q={name_raw}&postal_code={postal_code}"
                  response = requests.get(flipp_url, headers={"User-Agent": "Mozilla/5.0"}).json()
                  flipp_results = response.get('items', [])

                  new_price = None
                  match_name = None

                  for res in flipp_results:
                      merchant = (res.get('merchant_name') or "").lower()
                      title = (res.get('name') or "").lower()
                      
                      # 1. Store Match
                      if target_store in merchant:
                          # 2. Brand Match (only if brand is specified in DB)
                          if brand and brand not in title:
                              continue
                          
                          # 3. Robust Price Check (checking 4 different fields)
                          raw_val = (
                              res.get('current_price') or 
                              res.get('price') or 
                              res.get('price_text') or 
                              res.get('sale_price')
                          )
                          
                          found_price = clean_price(raw_val)
                          if found_price:
                              new_price = found_price
                              match_name = res.get('name')
                              break

                  if new_price:
                      supabase.table("prices").update({
                          "price": new_price,
                          "last_automated_update": "now()"
                      }).eq("id", item['id']).execute()
                      print(f"   ‚úÖ SUCCESS: Found '{match_name}' -> ${new_price}")
                  else:
                      print(f"   ‚ùå NO PRICE: Found matches for '{name_raw}' but couldn't extract a valid price.")

              except Exception as e:
                  print(f"   ‚ö†Ô∏è SYSTEM ERROR on {item.get('item_name', 'Unknown')}: {str(e)}")
          EOF
