name: Weekly Price Watcher (Flipp refined)
on:
  schedule:
    - cron: '0 0 * * 0' # Sunday at Midnight
  workflow_dispatch:

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests supabase

      - name: Run Flipp Scraper
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python - <<EOF
          import os
          import requests
          from supabase import create_client

          supabase = create_client(os.getenv("SUPABASE_URL"), os.getenv("SUPABASE_KEY"))
          
          # 1. Fetch only items with 'is_watched' set to True
          items = supabase.table("prices").select("*").eq("is_watched", True).execute().data
          postal_code = "T6X1V3"

          print(f"Checking {len(items)} items on Flipp for Edmonton area...")

          for item in items:
              try:
                  # REFINED SEARCH: Combination of Brand + Item Name
                  # If brand exists: "Begum Basmati Rice", else: "Basmati Rice"
                  brand = item.get('brand') or ""
                  item_name = item.get('item_name') or ""
                  query = f"{brand} {item_name}".strip()
                  
                  target_store = item['store_name'].lower() 
                  
                  print(f"\nüîç SEARCHING: '{query}' for Store: {target_store}")

                  # Flipp Internal Search Endpoint
                  flipp_url = f"https://backflipp.wishabi.com/flipp/items/search?q={query}&postal_code={postal_code}"
                  headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"}
                  
                  response = requests.get(flipp_url, headers=headers).json()
                  results = response.get('items', [])

                  new_price = None
                  
                  for res in results:
                      merchant = res.get('merchant_name', '').lower()
                      
                      # Match the store (e.g., 'walmart' in 'Walmart Canada')
                      if target_store in merchant:
                          # ROBUST PRICE CHECK: Flipp uses several different keys
                          # We check them in order of reliability
                          price = (
                              res.get('current_price') or 
                              res.get('price') or 
                              res.get('sale_price') or 
                              res.get('original_price')
                          )
                          
                          if price:
                              new_price = price
                              print(f"   ‚úÖ MATCH FOUND: {res.get('name')} -> ${new_price}")
                              break 

                  if new_price:
                      # 3. Update Supabase
                      supabase.table("prices").update({
                          "price": float(new_price),
                          "last_automated_update": "now()"
                      }).eq("id", item['id']).execute()
                      print(f"   üöÄ Database Updated successfully.")
                  else:
                      print(f"   ‚ùå No match found for '{query}' at {target_store} in T6X 1V3.")

              except Exception as e:
                  print(f"   ‚ö†Ô∏è Error processing {item.get('item_name')}: {str(e)}")
          EOF
